<!-- templates/index.html (续) -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频转码管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .task-card {
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .task-progress {
            height: 8px;
        }

        .status-pending {
            background-color: #ffc107;
        }

        .status-running {
            background-color: #0d6efd;
        }

        .status-completed {
            background-color: #198754;
        }

        .status-failed {
            background-color: #dc3545;
        }

        .status-cancelled {
            background-color: #6c757d;
        }

        .infinite-scroll-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .file-name {
            word-break: break-all;
            font-size: 0.9em;
        }

        .task-actions {
            white-space: nowrap;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-film"></i> 视频转码管理系统
            </h1>
        </div>
    </div>

    <!-- 配置面板 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> 系统配置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">扫描目录</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="scanDirectory" placeholder="请输入扫描目录">
                                <button class="btn btn-outline-secondary" type="button" id="browseDirectory">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">并发任务数</label>
                            <input type="number" class="form-control" id="maxConcurrent" min="1" max="10" value="2">
                        </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">FFmpeg参数</label>
                            <input type="text" class="form-control" id="ffmpegParams"
                                   value="-c:v libsvtav1 -crf 28 -b:v 0 -preset 6 -c:a copy">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button class="btn btn-primary" id="saveConfig">
                                <i class="bi bi-save"></i> 保存配置
                            </button>
                            <button class="btn btn-success" id="startScan">
                                <i class="bi bi-search"></i> 开始扫描
                            </button>
                            <button class="btn btn-info" id="refreshStats">
                                <i class="bi bi-arrow-repeat"></i> 刷新统计
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart"></i> 任务统计
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">总计</h6>
                                    <h3 id="totalTasks">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h6 class="card-title">等待</h6>
                                    <h3 id="pendingTasks">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h6 class="card-title">进行中</h6>
                                    <h3 id="runningTasks">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h6 class="card-title">完成</h6>
                                    <h3 id="completedTasks">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <h6 class="card-title">失败</h6>
                                    <h3 id="failedTasks">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body">
                                    <h6 class="card-title">已取消</h6>
                                    <h3 id="cancelledTasks">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务列表过滤 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary filter-btn active" data-status="all">
                    <i class="bi bi-list"></i> 全部
                </button>
                <button type="button" class="btn btn-outline-warning filter-btn" data-status="pending">
                    <i class="bi bi-clock"></i> 等待
                </button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-status="running">
                    <i class="bi bi-play-circle"></i> 进行中
                </button>
                <button type="button" class="btn btn-outline-success filter-btn" data-status="completed">
                    <i class="bi bi-check-circle"></i> 完成
                </button>
                <button type="button" class="btn btn-outline-danger filter-btn" data-status="failed">
                    <i class="bi bi-x-circle"></i> 失败
                </button>
                <button type="button" class="btn btn-outline-secondary filter-btn" data-status="cancelled">
                    <i class="bi bi-trash"></i> 已取消
                </button>
            </div>
        </div>
    </div>

    <!-- 任务列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-task"></i> 转码任务列表
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshTasks">
                            <i class="bi bi-arrow-repeat"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="tasksContainer">
                        <!-- 任务将在这里动态加载 -->
                    </div>
                    <div class="infinite-scroll-loading" id="loadingIndicator">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">加载更多任务...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetailContent">
                    <!-- 任务详情将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
    // 全局变量
    let currentPage = 1;
    let currentStatus = 'all';
    let isLoading = false;
    let hasMore = true;

    // 初始化
    $(document).ready(function () {
        loadConfig();
        loadStats();
        loadTasks();

        // 绑定事件
        bindEvents();

        // 定时刷新统计
        setInterval(loadStats, 5000);
        setInterval(loadTasks, 3000);
    });

    // 绑定事件
    function bindEvents() {
        // 保存配置
        $('#saveConfig').click(saveConfig);

        // 开始扫描
        $('#startScan').click(startScan);

        // 刷新统计
        $('#refreshStats').click(loadStats);

        // 刷新任务
        $('#refreshTasks').click(function () {
            currentPage = 1;
            hasMore = true;
            loadTasks(true);
        });

        // 状态过滤
        $('.filter-btn').click(function () {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');
            currentStatus = $(this).data('status');
            currentPage = 1;
            hasMore = true;
            loadTasks(true);
        });

        // 滚动加载
        $(window).scroll(function () {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                loadMoreTasks();
            }
        });
    }

    // 加载配置
    function loadConfig() {
        $.get('/api/config')
            .done(function (data) {
                $('#scanDirectory').val(data.scan_directory);
                $('#maxConcurrent').val(data.max_concurrent);
                $('#ffmpegParams').val(data.ffmpeg_params);
            })
            .fail(function () {
                showAlert('加载配置失败', 'danger');
            });
    }

    // 保存配置
    function saveConfig() {
        const config = {
            scan_directory: $('#scanDirectory').val(),
            max_concurrent: $('#maxConcurrent').val(),
            ffmpeg_params: $('#ffmpegParams').val()
        };

        $.ajax({
            url: '/api/config',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(config),
            success: function () {
                showAlert('配置保存成功', 'success');
            },
            error: function () {
                showAlert('配置保存失败', 'danger');
            }
        });

    }

    // 开始扫描
    function startScan() {
        const directory = $('#scanDirectory').val();
        if (!directory) {
            showAlert('请输入扫描目录', 'warning');
            return;
        }

        $.ajax({
            url: '/api/scan',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({directory: directory}),
            success: function () {
                showAlert('开始扫描目录: ' + directory, 'info');
                setTimeout(loadStats, 2000);
            },
            error: function () {
                showAlert('扫描启动失败', 'danger');
            }
        });

    }

    // 加载统计信息
    function loadStats() {
        $.get('/api/stats')
            .done(function (data) {
                $('#totalTasks').text(data.total);
                $('#pendingTasks').text(data.pending);
                $('#runningTasks').text(data.running);
                $('#completedTasks').text(data.completed);
                $('#failedTasks').text(data.failed);
                $('#cancelledTasks').text(data.cancelled);
            })
            .fail(function () {
                console.log('加载统计信息失败');
            });
    }

    // 加载任务列表
    function loadTasks(clear = false) {
        if (isLoading) return;

        isLoading = true;
        if (clear) {
            $('#tasksContainer').empty();
        }

        $.get(`/api/tasks?page=${currentPage}&per_page=20&status=${currentStatus}`)
            .done(function (data) {
                if (clear) {
                    $('#tasksContainer').empty();
                }

                if (data.tasks.length === 0) {
                    if (currentPage === 1) {
                        $('#tasksContainer').html('<div class="text-center py-5"><p class="text-muted">暂无任务</p></div>');
                    }
                    hasMore = false;
                } else {
                    renderTasks(data.tasks);
                    hasMore = currentPage < data.total_pages;
                }
            })
            .fail(function () {
                if (currentPage === 1) {
                    $('#tasksContainer').html('<div class="text-center py-5"><p class="text-danger">加载任务失败</p></div>');
                }
            })
            .always(function () {
                isLoading = false;
            });
    }

    // 加载更多任务
    function loadMoreTasks() {
        if (isLoading || !hasMore) return;

        currentPage++;
        loadTasks();
    }

    function renderTasks(tasks) {
        const container = $('#tasksContainer');

        // 如果是第一页，清空容器
        if (currentPage === 1) {
            container.empty();
        }

        tasks.forEach(function (task) {
            const taskElement = createTaskElement(task);
            container.append(taskElement);
        });
    }

    // 创建任务元素
    function createTaskElement(task) {
        const statusClass = `status-${task.status}`;
        const statusText = getStatusText(task.status);
        const progress = task.progress || 0;

        const element = $(`
                <div class="card task-card mx-3 my-2" data-task-id="${task.id}">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="file-name text-truncate" title="${task.input_file}">
                                    <i class="bi bi-file-earmark-play"></i> ${task.input_file}
                                </div>
                                <small class="text-muted">${formatFileSize(getFileSize(task.input_file))}</small>
                            </div>
                            <div class="col-md-3">
                                <div class="progress task-progress mb-1">
                                    <div class="progress-bar ${statusClass}"
                                         role="progressbar"
                                         style="width: ${progress}%">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-${getStatusColor(task.status)}">${statusText}</span>
                                    <span>${progress}%</span>
                                </div>
                            </div>
                            <div class="col-md-3 task-actions text-end">
                                <button class="btn btn-sm btn-outline-primary view-detail"
                                        data-task-id="${task.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${task.status === 'pending' || task.status === 'running' ?
            `<button class="btn btn-sm btn-outline-danger cancel-task"
                                        data-task-id="${task.id}">
                                    <i class="bi bi-x"></i>
                                </button>` : ''}
                                <small class="d-block text-muted">
                                    ${formatTime(task.created_time)}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `);

        // 绑定事件
        element.find('.view-detail').click(function () {
            showTaskDetail($(this).data('task-id'));
        });

        element.find('.cancel-task').click(function () {
            cancelTask($(this).data('task-id'));
        });

        return element;
    }

    // 显示任务详情
    function showTaskDetail(taskId) {
        $.get(`/api/tasks/${taskId}`)
            .done(function (task) {
                const detailHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基本信息</h6>
                                <p><strong>状态:</strong> ${getStatusText(task.status)}</p>
                                <p><strong>进度:</strong> ${task.progress || 0}%</p>
                                <p><strong>创建时间:</strong> ${formatTime(task.created_time)}</p>
                                ${task.start_time ? `<p><strong>开始时间:</strong> ${formatTime(task.start_time)}</p>` : ''}
                                ${task.end_time ? `<p><strong>结束时间:</strong> ${formatTime(task.end_time)}</p>` : ''}
                            </div>
                            <div class="col-md-6">
                                <h6>文件信息</h6>
                                <p><strong>输入文件:</strong> ${task.input_file}</p>
                                <p><strong>输出文件:</strong> ${task.output_file}</p>
                            </div>
                        </div>
                        ${task.error ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>错误信息</h6>
                                <div class="alert alert-danger">
                                    ${task.error}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>FFmpeg参数</h6>
                                <pre class="bg-light p-2 small">${task.ffmpeg_params}</pre>
                            </div>
                        </div>
                    `;
                $('#taskDetailContent').html(detailHtml);
                new bootstrap.Modal(document.getElementById('taskDetailModal')).show();
            })
            .fail(function () {
                showAlert('加载任务详情失败', 'danger');
            });
    }

    // 取消任务
    function cancelTask(taskId) {
        if (!confirm('确定要取消此任务吗？')) {
            return;
        }

        $.post(`/api/tasks/${taskId}/cancel`)
            .done(function () {
                showAlert('任务已取消', 'success');
                setTimeout(loadTasks, 1000);
            })
            .fail(function () {
                showAlert('取消任务失败', 'danger');
            });
    }

    // 获取状态文本
    function getStatusText(status) {
        const statusMap = {
            'pending': '等待中',
            'running': '进行中',
            'completed': '已完成',
            'failed': '失败',
            'cancelled': '已取消'
        };
        return statusMap[status] || status;
    }

    // 获取状态颜色
    function getStatusColor(status) {
        const colorMap = {
            'pending': 'warning',
            'running': 'primary',
            'completed': 'success',
            'failed': 'danger',
            'cancelled': 'secondary'
        };
        return colorMap[status] || 'secondary';
    }

    // 格式化时间
    function formatTime(timeStr) {
        if (!timeStr) return '';
        try {
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN');
        } catch (e) {
            return timeStr;
        }
    }

    // 获取文件大小（从服务器获取真实大小）
    function getFileSize(filePath) {
        // 通过AJAX请求获取真实文件大小
        let fileSize = 0;
        $.ajax({
            url: '/api/file/size',
            method: 'POST',
            async: false,  // 同步请求以确保获取到数据
            contentType: 'application/json',
            data: JSON.stringify({file_path: filePath}),
            success: function (data) {
                fileSize = data.size || 0;
            },
            error: function () {
                fileSize = 0;
            }
        });
        return fileSize;
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 显示提示信息
    function showAlert(message, type = 'info') {
        // 创建提示元素
        const alertId = 'alert-' + Date.now();
        const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3"
                     style="z-index: 1050;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

        $('body').append(alertHtml);

        // 3秒后自动消失
        setTimeout(() => {
            $(`#${alertId}`).fadeOut(() => {
                $(`#${alertId}`).remove();
            });
        }, 3000);
    }

    // 处理文件选择对话框（在这个简单的版本中使用输入框）
    $('#browseDirectory').click(function () {
        const directory = prompt('请输入目录路径:');
        if (directory) {
            $('#scanDirectory').val(directory);
        }
    });
</script>
</body>
</html>